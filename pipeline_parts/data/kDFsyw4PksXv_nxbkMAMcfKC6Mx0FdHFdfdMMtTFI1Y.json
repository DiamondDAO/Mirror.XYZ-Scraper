"{\"content\":{\"body\":\"Hello everyone, This is Akash! Things are getting better everyday and I hope everyone is good. I am working as a MERN stack developer in TCS. In recent times I came across Nextjs and it is one of the best frameworks available for developing web applications. As the official [website](https://nextjs.org/) says, it is React framework for production, which gives all the features you need for production like hybrid static & server rendering, TypeScript support, smart bundling, route pre-fetching etc. In this blog I would like to show you how to use AWS Amplify with Next and how to authorize users.\\n\\n## Creating new Next app\\n\\nCreating a new next app is as simple as executing a command in the terminal. For starters, make sure you have node and npx installed in your pc.\\n\\n    $ npx create-next-app nextapp\\n\\nHere \\\"nextapp\\\" is the name of the app. Now open this new app in your preferred code editor.\\n\\n## Start Next server\\n\\nOnce you open the nextapp directory in any editor, you can observe various files and directories. We have to create and write code for our web pages in the “pages” directory. Our entire website starts at \\\"pages/\\\\_app.js\\\". Execute the below command to start the server.\\n\\n    $ npm run dev\\n\\nThis command starts the server on port 3000. You can open any browser and go to [localhost:3000](http://localhost:3000/) for accessing your app.\\n\\nThe content of the page you see at [localhost:3000](http://localhost:3000/) is in pages/index.js file. \\\"pages\\\" help us create pages for our app and each of them is associated with a route based on its file name. For example, content of pages/index.js can be seen at [localhost:3000](http://localhost:3000/) and pages/about.js at [localhost:3000/about](http://localhost:3000/about) etc. To know more about pages, refer [this](https://nextjs.org/docs/basic-features/pages)\\n\\n## Initialising Amplify\\n\\nAWS Amplify is a set of tools and services that can be used together, or on their own, to help front-end web and mobile developers build scalable full stack applications, powered by AWS. You can install amplify cli using npm.\\n\\n    $ npm install -g @aws-amplify/cli\\n\\nNow initialise amplify at the root of our app and stick on to the default configurations as mentioned.\\n\\n    $ amplify init\\n\\n    ? Enter a name for the project nextapp\\n    The following configuration will be applied:\\n\\n    Project information\\n    | Name: nextapp\\n    | Environment: dev\\n    | Default editor: Visual Studio Code\\n    | App type: javascript\\n    | Javascript framework: react\\n    | Source Directory Path: src\\n    | Distribution Directory Path: build\\n    | Build Command: npm run-script build\\n    | Start Command: npm run-script start\\n\\n    ? Initialize the project with the above configuration? Yes\\n    ? Select the authentication method you want to use: AWS profile\\n    ? Please choose the profile you want to use default\\n\\nAfter that, add authentication service\\n\\n    $ amplify add auth\\n\\n    Do you want to use the default authentication and security configuration? Default configuration\\n    How do you want users to be able to sign in? Username\\n    Do you want to configure advanced settings? No, I am done.\\n\\nNow deploy the service\\n\\n    $ amplify push --y\\n\\n## Creating pages\\n\\nInstall the packages below as we use them in our app in the further steps.\\n\\n    $ npm install aws-amplify @aws-amplify/ui-react @emotion/css\\n\\nIn our app, we are going to maintain a state to store the authentication status of a user. Inorder to access that state information in our pages and components, we will use useContext react hook. For that, create a directory libs and file contextLib.js in libs. Write below code in contextLib.js\\n\\n    // libs/contextLib.js\\n    import { useContext, createContext } from \\\"react\\\";\\n\\n    export const AppContext = createContext(null);\\n\\n    export function useAppContext() {\\n      return useContext(AppContext);\\n    }\\n\\nHere we are creating and exporting a context object called AppContext, a function which will return a useContext function. These two will be imported in subsequent files. Lets update pages/\\\\_app.js.\\n\\nReplace content of \\\\_app.js with below\\n\\n    import {useState, useEffect} from 'react'\\n    import Amplify, { Auth } from 'aws-amplify'\\n    import config from '../src/aws-exports'\\n    import Link from 'next/link'\\n    import {css} from '@emotion/css'\\n    import { AppContext } from \\\"../libs/contextLib\\\";\\n    import '../styles/globals.css'\\n\\n    Amplify.configure({\\n     ...config,\\n     ssr: true\\n    })\\n\\n    export default function MyApp({ Component, pageProps }) {\\n     const [isAuthenticated, setIsAuthenticated] = useState(false)\\n\\n     useEffect(() => {\\n       Auth.currentAuthenticatedUser()\\n         .then(() => {\\n           setIsAuthenticated(true)\\n         })\\n         .catch(err => setIsAuthenticated(false))\\n     }, [])\\n\\n     console.log('Auth: ', isAuthenticated)\\n     return (\\n       <div>\\n         <nav className={navStyle}>\\n           <Link href=\\\"/\\\">\\n             <span className={linkStyle}>About</span>\\n           </Link>\\n           <Link href=\\\"/home\\\">\\n             <span className={linkStyle}>Home</span>\\n           </Link>\\n           {\\n             !isAuthenticated &&\\n             <Link href=\\\"/login\\\">\\n               <span className={linkStyle}>Login</span>\\n             </Link>\\n           }\\n         </nav>\\n         <AppContext.Provider value={{\\n           isAuthenticated,\\n           setIsAuthenticated\\n         }}>\\n           <Component {...pageProps} />\\n         </AppContext.Provider>\\n       </div>\\n     )\\n    }\\n\\n    const linkStyle = css`\\n     margin-right: 20px;\\n     cursor: pointer;\\n    `\\n\\n    const navStyle = css`\\n     float: right;\\n     margin-top: 10px;\\n    `\\n\\nThere are a few things to notice here. AppContext is imported from libs/contextLib.js. We are creating \\\"isAuthenticated\\\" state and \\\"setIsAuthenticated\\\" function using useState react hook. We also use Amplify from 'aws-amplify' to configure our app and enable Amplify SSR.\\n\\nThe \\\"Component\\\" is wrapped with AppContext. isAuthenticated, setIsAuthenticated are passed to the value of AppContext Provider. With this we can access those fields in our components and pages.\\n\\nNext let’s create two components, AuthenticatedRoute and UnauthenticatedRoute, inside “components” directory at root of app.\\n\\n    // components/AuthenticatedRoute.js\\n    import { useAppContext } from \\\"../libs/contextLib\\\"\\n    import { useRouter } from \\\"next/router\\\";\\n\\n    const AuthenticatedRoute = (WrappedComponent) => {\\n       return (props) => {\\n           const { isAuthenticated } = useAppContext();\\n           const Router = useRouter();\\n           if (typeof window !== \\\"undefined\\\") {\\n               if (!isAuthenticated) {\\n                   Router.push(\\\"/login\\\");\\n                   return null;\\n               }\\n               return <WrappedComponent {...props} />;\\n           }\\n           // If we are on server, return null\\n           return null;\\n       };\\n    };\\n\\n    export default AuthenticatedRoute;\\n\\n<!---->\\n\\n    // components/UnauthenticatedRoute.js\\n    import { useAppContext } from \\\"../libs/contextLib\\\"\\n    import { useRouter } from 'next/router'\\n\\n    const UnauthenticatedRoute = (WrappedComponent) => {\\n       return (props) => {\\n           const { isAuthenticated } = useAppContext();\\n           const Router = useRouter();\\n           if (typeof window !== \\\"undefined\\\") {\\n               if (isAuthenticated) {\\n                   Router.replace(\\\"/home\\\");\\n                   return null;\\n               }\\n               return <WrappedComponent {...props} />;\\n           } \\n           // If we are on server, return null\\n           return null;\\n       };\\n    };\\n\\n    export default UnauthenticatedRoute\\n\\nIn these components, we imported useAppContext from libs and we are using isAuthenticated state to determine whether the user is authenticated or not. Based on the isAuthenticated value, we return the page, which the user wants to access or redirect them to respective default pages. These two components are exported such that pages are wrapped around them.\\n\\nreplace pages/index.js with below\\n\\n    // pages/index.js\\n    import Link from 'next/link'\\n    import AuthenticatedRoute from '../components/AuthenticatedRoute'\\n    import styles from '../styles/Home.module.css'\\n\\n    function Index() {\\n     return (\\n       <div className={styles.container}>\\n         <h3>\\n           Index\\n         </h3>\\n       </div>\\n     )\\n    }\\n\\n    export default AuthenticatedRoute(Index)\\n\\nHome.module.css is not modified.\\n\\nCreate home.js and login.js in pages.\\n\\n    // pages/home.js\\n    import AuthenticatedRoute from \\\"../components/AuthenticatedRoute\\\";\\n    import { AmplifySignOut } from '@aws-amplify/ui-react'\\n    import { useAppContext } from \\\"../libs/contextLib\\\";\\n\\n    function Home(props) {\\n       const { setIsAuthenticated } = useAppContext();\\n       return (\\n           <div>\\n               <h1>Homeee!!!</h1>\\n               <AmplifySignOut style={{\\n                   width: 400\\n               }} onClick={() => {\\n                   setIsAuthenticated(false)\\n               }}/>\\n           </div>\\n       )\\n    }\\n\\n    export default AuthenticatedRoute(Home);\\n\\n<!---->\\n\\n    // pages/login.js\\n    import { useState, useEffect } from 'react'\\n    import { Auth } from 'aws-amplify'\\n    import { withAuthenticator } from '@aws-amplify/ui-react'\\n    import { useAppContext } from \\\"../libs/contextLib\\\";\\n    import UnauthenticatedRoute from '../components/UnauthenticatedRoute';\\n\\n    function Login() {\\n     const { data, setIsAuthenticated } = useAppContext();\\n     const [user, setUser] = useState(null)\\n     useEffect(() => {\\n       // Access the user session on the client\\n       Auth.currentAuthenticatedUser()\\n         .then(user => {\\n           console.log(\\\"User: \\\", user)\\n           setUser(user)\\n           setIsAuthenticated(true)\\n         })\\n         .catch(err => setUser(null))\\n     }, [])\\n     return (\\n       <div>\\n         { user && <h1>Welcome, {user.username}: {data}</h1> }\\n       </div>\\n     )\\n    }\\n\\n    export default withAuthenticator(UnauthenticatedRoute(Login))\\n\\nIt can be observed that home.js is exporting the Home component wrapped around AuthenticatedRoute and the same with index.js as well. login.js is exporting a Login component wrapped around UnauthenticatedRoute. Also, we are using withAuthenticator from '[@aws](https://hashnode.com/@aws)-amplify/ui-react' so that we can signup and signin users. useEffect() in login.js is checking if any user is authenticated and based on that it is changing the isAuthenticated value using setIsAuthenticated function.\\n\\nNow restart the server to see all the changes that are made. Trying to access \\\"home\\\" or \\\"about\\\" without authentication is not possible because those are Authenticated routes. This provides page level authorizations.\\n\\n## Conclusion\\n\\nCheck out the complete source code for this blog [here](https://github.com/Akash76/nextapp). Next is getting more attention these days and it is time for us to dig deeper and know its roots. In this blog we saw how to authorize users in Nextjs. Checkout more about Next in their official website and make the best out of it. I’m always up for any discussions and collaborations.\\n\\nUntil the next time, Stay safe!!!\\n\",\"timestamp\":1639989411,\"title\":\"A Guide to user authorization in Nextjs\"},\"digest\":\"JGXIYaFhPN2aO0k8XoaVt1y05L7LJXWMzR4muOkuroE\",\"authorship\":{\"contributor\":\"0xc9FA760395cabAdECfEc59109d0d056D493D855e\",\"signingKey\":\"{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"JJEqVLuztdgUhN7jYDcfeaqKqTFmJFqM0JJ59XcKOxs\\\",\\\"y\\\":\\\"PTiioyIYPbeekN5X_gyG4TX9ctqjahF8tHWPtjVuv4w\\\"}\",\"signature\":\"Ztq88E1PpWPzO9fA0tA9Qpu17J6CtZqqUERoCyBJSLxMCjfsfZCB_DMC-itpn47ZCD0LVJXh8HpQSWhqIXcOhA\",\"signingKeySignature\":\"0xc45cb5c22e1a083b68387363bf319716c223a38a86c0e31bca89fba67ae21b434f473740e10c9ebe2ad4e6575768ac7c345c59c27bb1b006c3856357f8105af81b\",\"signingKeyMessage\":\"I authorize publishing on mirror.xyz from this device using:\\n{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"JJEqVLuztdgUhN7jYDcfeaqKqTFmJFqM0JJ59XcKOxs\\\",\\\"y\\\":\\\"PTiioyIYPbeekN5X_gyG4TX9ctqjahF8tHWPtjVuv4w\\\"}\",\"algorithm\":{\"name\":\"ECDSA\",\"hash\":\"SHA-256\"}},\"nft\":{},\"version\":\"12-21-2020\",\"originalDigest\":\"JGXIYaFhPN2aO0k8XoaVt1y05L7LJXWMzR4muOkuroE\"}"