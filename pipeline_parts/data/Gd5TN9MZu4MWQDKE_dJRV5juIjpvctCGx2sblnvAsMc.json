"{\"content\":{\"body\":\"在《儒林外史》里有一个吝啬鬼叫严监生，临终前躺在床上，竖起两根指头来。家里的侄子，奶妈就围着他问，是不是有什么心愿未了，却都不解其意。最后，严监生的老婆赵氏猜到了原因，屋子里的灯点着两茎灯草，严监生觉得太浪费了，才迟迟不肯咽气。当赵氏把灯里的灯草挑掉了一茎，严监生这才两腿一蹬，双眼一闭，安心去投胎了。\\n\\n假设在多年轮回后，严监生在 2017 年成了一个数字资产投资者。这天他用 imToken 1.0 给赵氏转账了 10 个 USDT，却仍不改其吝啬的本质，把手续费设定得很低，可这笔交易过了很久也没有显示转账成功。\\n\\n严监生有些焦急，又给赵氏发去了一笔 10 个 USDT 的转账，这次手续费多给了一些，很快便成功了，而原先发起的第一笔交易则显示失败。\\n\\nEmmmm\\\\~ 这是为什么呢？\\n\\n![](https://images.mirror-media.xyz/publication-images/fcW3XVEBMYpmB4aKh9Yqg.png?height=347&width=462)\\n\\n最近以太坊网络转账的矿工费越来越贵，原因我们在《为什么矿工费这么贵？》解释过了，那么面对昂贵的矿工费，多数人都会选择把矿工费调低一些，毕竟节俭一点没啥不好的。\\n\\n可是当我们使用 imToken 1.0 进行转账，把手续费调得很低时就可能会出现上面这种情况：第一笔交易迟迟不被打包，再次发起第二笔交易成功后，第一笔交易则会显示失败。\\n\\n究其原因，是一个叫 nonce 的值造成的。\\n\\n在以太坊上发生的每笔交易都有一个值叫 nonce，这个值用于计算一个以太坊地址中发出的交易数量。一个以太坊地址里的所有转账会按照你发起转账的时间，给每一笔交易排序，从 0 开始计数。地址每发送一笔交易，交易的随机数 nonce 就会增加 1，而转入这个地址的交易则不会改变 nonce 值。\\n\\n举个例子：0x336d3e7fdFB677Bd1c7324919556EB6E98F6eDEF\\n\\n这个地址中截止撰稿一共向外发起了 4 笔向外转账和 2 笔进账收款，其中红色框框标出的这两笔交易不纳入该地址的 nonce 值计算，其余 4 笔向外转账交易的 nonce 值从下往上分别为 0，1，2，3。\\n\\n![](https://images.mirror-media.xyz/publication-images/ZjysQFxH4YYrOFlBF6hAi.png?height=363&width=750)\\n\\n以太坊区块链对 nonce 做了这样三条规定：\\n\\n1. 矿工需要按照 nonce 值从小到大去打包转账，所以在 nonce 为 0 的交易未被矿工打包前，nonce 为 1，2，3···的交易无论矿工费给的多高，都必须一直排队等着（就好比早高峰堵车的时候我们不能加塞，无论是拉斯莱斯还是奇瑞，都只能老老实实排队）。\\n2. nonce 是连续的，不能跳过。当 nonce 为 1 的交易没有发起时，nonce 不能从 0 直接跳到 2，即 nonce 为 2 的交易只能发生在 nonce 为 1 的交易后面。\\n3. 如果有两笔交易 nonce 相同，其中一笔交易成功后，另外一笔交易就会显示被替代，转账失败。\\n\\n严监生在使用 imToken 1.0 进行转账时，第一笔 nonce 为 0 的交易，因为手续费过低，没有被矿工及时打包，一直处于等待状态。这时他再次发起的第二笔交易 nonce 值，你猜是 0 还是 1？\\n\\n答案是 0。\\n\\n你可能有点疑惑，前面不是说随着地址每发出一笔向外转账， nonce 值就会 +1 么，怎么这里两笔转账的 nonce 值却都是 0 呢？\\n\\n原因是 imToken 1.0 不支持发起连续转账，如果在第一笔交易未被成功打包的情况下，就连续发送下一笔交易，其中一笔就一定会失败，这是因为这两笔交易使用的是相同的 nonce 值。\\n\\n根据以太坊 nonce 的第三条规则，当有两个 nonce 值相同的交易发生时，就只能有一笔交易被成功打包，一山不容二虎。同理，在第一笔交易没有转账成功时，后续发起的第二笔、第三笔、···· 第 n 笔交易的 nonce 值均为 0，其中只有一笔交易能被矿工成功打包，其他的交易会全部显示失败。那么，哪笔交易能成功呢，有什么判断标准么？\\n\\nNonce 值相同的交易，给矿工的手续费最高的那笔更容易成功，这不是以太坊区块链的规定，而是矿工们逐利使然，谁不想多赚点钱呢。矿工当然就会选择给的手续费更多的那笔交易来打包，其他的相同 nonce 的交易则都会被矿工丢弃，显示在你的钱包软件里就是失败的状态。\\n\\n这 n 笔先后发起， nonce 值相同的交易，就像是起跑线不同，终点线却相同的运动员，只有第一名的飞人博尔特能被大众关注，其他人则籍籍无名。\\n\\n![](https://images.mirror-media.xyz/publication-images/N3afC3BManv6iT-rZnL82.png?height=336&width=500)\\n\\n升级后的 imToken 2.0 则支持发起连续转账，如果严监生是用 imToken 2.0 进行转账，那么他的第一笔交易 nonce 值为 0，第二笔交易 nonce 值则为 1，即便前面的交易还未被打包，后续发起的交易 nonce 值也会自动累加 1。\\n\\n上面我们提到了 nonce 为 0 的交易未被矿工打包时，nonce 为 1 的交易就得一直等着，所以虽然后续发起的交易 nonce 值可以累加，却必须排队等着 nonce 值更小的交易被打包后，才能轮到自己。\\n\\n这 n 笔先后发起， nonce 值不断累加的交易，就像是起跑线不同，终点线也不同的运动员，但必须等到第一跑道的运动员到达终点后，第二、三、··· n  跑道的运动员才可以起跑。\\n\\n如果第一跑道的人是博尔特，那么后续的几笔交易也能很快陆续上场，可要是第一跑道的人是海绵宝宝的宠物——小蜗，那后面跑道的运动员们可能就得等到天荒地老了。这个时候就该给小蜗一根能量棒，提提速！\\n\\n![](https://images.mirror-media.xyz/publication-images/LLcVX9j529uxmkLzraCRX.png?height=375&width=500)\\n\\nimToken 2.0 针对到账慢的交易推出了加速功能，这个功能就像是一个能量棒，吃下去后就能让交易迅速被矿工打包。imToken 会根据以太坊上的网络情况，自动帮你计算出性价比最高的矿工费，点击「加速交易」，就可以完成交易加速打包。\\n\\n![](https://images.mirror-media.xyz/publication-images/wm8uncGfsa7ut5fpgxjoO.png?height=347&width=543)\\n\\n「加速交易」的原理其实也很简单，就是再发起一笔 nonce 值相同，但矿工费更高的转账，来覆盖原来的。这样这笔交易就会更快被打包，原来的转账则被替代掉。\\n\\n如果你拿不准自己转账的矿工费该如何设定，是贵了还是便宜了。别担心，最新版的 imToken 已经支持三挡变速，「快速、一般、缓慢」三种交易打包速度，任你选择。\\n\\n小结：\\n\\nimToken 1.0 不支持交易加速和连续发起多笔交易。当一笔交易设置的矿工费过低时，会导致迟迟不被打包，也无法进行加速。而如果在第一笔交易还未成功被打包，就急于发起第二笔交易，则会导致其中一笔交易失败。\\n\\nimToken 2.0 支持交易加速、三挡变速和连续发起多笔交易。当一笔交易设置的矿工费过低时，可以追加矿工费，加速打包确认。在最新版 imToken 中，你可以按需选择矿工费，「三挡变速」一目了然；如果不介意打包时间的话，可以连续发起多笔交易，静静等待交易被打包确认就可以了。\",\"timestamp\":1636620574,\"title\":\"决定转账顺序的 Nonce\"},\"digest\":\"nn836GJmeRKmdpB1A0hBJ9N-avcvXP6ZSemXqGiwPfE\",\"authorship\":{\"contributor\":\"0x8a256b5C5b239dCc36d6D334449b4242C26f7Ad2\",\"signingKey\":\"{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"cbM1K14fcL6BcZtN1eENlXhkvUocA5GcLSAdTbC9NoM\\\",\\\"y\\\":\\\"7aQbVKQWxKsFc0IVgF3tZn9KI--8APNeZCb-EXRalsI\\\"}\",\"signature\":\"6WrBMpy8mXQVV5R8AB58eKsuCWabm6eeH4mUJCft5jSmVYJ5s26Kz7tYyxZ1AT9E2MALkf8ZyKoVsOBHqCmV1Q\",\"signingKeySignature\":\"0xf1827d191b60db36535c21b65b978503f9d81ccd145d437901e7000a6835c85a7ac55121827aa7c3736626fd9f2f10f5c760e8410969c9b1f21969cd77c279891c\",\"signingKeyMessage\":\"I authorize publishing on mirror.xyz from this device using:\\n{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"cbM1K14fcL6BcZtN1eENlXhkvUocA5GcLSAdTbC9NoM\\\",\\\"y\\\":\\\"7aQbVKQWxKsFc0IVgF3tZn9KI--8APNeZCb-EXRalsI\\\"}\",\"algorithm\":{\"name\":\"ECDSA\",\"hash\":\"SHA-256\"}},\"nft\":{},\"version\":\"12-21-2020\",\"originalDigest\":\"nn836GJmeRKmdpB1A0hBJ9N-avcvXP6ZSemXqGiwPfE\"}"