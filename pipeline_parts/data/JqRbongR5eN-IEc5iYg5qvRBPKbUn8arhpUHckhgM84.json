"{\"content\":{\"body\":\"来源 | Ethereum Foundation Blog\\n\\n作者 | Tim Beiko\\n\\n以太坊向权益证明 (PoS) 的过渡——合并——已近在眼前：开发测试网正在被建立、规范正在被敲定，社区宣传也已经实打实地开展了。合并的设计就是希望以太坊以对其终端用户、智能合约和 dapp 带来最小影响的方式运行。也就是说，还是有一些小变更是需要强调的。在我们深入这些变更之前，读者可以通过以下几条链接了解整个合并架构的背景知识：\\n\\n*   路线图的演变\\n\\n    (https\\\\://www\\\\.ethereum.cn/Technology/allcoredev-update006)\\n\\n*   [合并后的客户端架构](http://mp.weixin.qq.com/s?\\\\__biz=Mzg5ODU3NjkwNg==\\\\&mid=2247483882\\\\&idx=1\\\\&sn=fdc2e1116cea147313641e1e81a5f96c\\\\&chksm=c061268ff716af995be0d8608484d1af9b83eac470ce425a638b5d99aadce39505d5eadcec19\\\\&scene=21#wechat_redirect)\\n\\n下文的内容将假设读者已经熟悉了上面的背景知识。对于那些想更深入了解的读者，下面的链接提供了合并的完整规范：\\n\\n*   执行层\\n*   共识层\\n*   引擎 API\\n\\n**区块结构**\\n\\n合并后，工作量证明区块将不再存在在网络上。相反，之前工作量证明的内容会变成在信标链上创建区块的组成部分。你可以把信标链想作成为以太坊的新权益证明共识层，取代了之前的工作量证明共识层。信标链区块将包含  ExecutionPayloads (执行数据) ，这是当前工作量证明链在合并后的等同物。下图展示了这种关系：\\n\\n![](https://oss-cdn1.bihu-static.com/image/20211203/68da4ecd0db34100a335aa023eef467b_GM3TCKRTHEYA.jpeg)\\\\\\n\\n\\n对于终端用户和应用层开发者，这些 ExecutionPayloads 就是与以太坊交互的地方。在这一层的交易将仍然由执行层客户端 (Besu、Erigon、Geth、Nethermind 等) 处理。幸运的是，考虑到执行层的稳定性，合并只会引入最小的破坏性变更。\\\\\\n\\n\\n**挖矿 & Ommer 区块字段**\\n\\n合并后，之前工作量证明区块头包含的几个字段将不再被使用，因为它们与权益证明不相关。为了尽量减少对工具和基础设施的影响，这些字段都会设为 0，或它们的数据结构等同物，而不是完全从这个数据结构移除。区块字段的完整变更可以查看 EIP-3675。\\n\\n![](https://oss-cdn1.bihu-static.com/image/20211203/e7d75e355a3545ef80531ce032d214e1\\\\_GEYDQMBKGE4DM.jpeg)\\\\\\n\\n\\n因为权益证明本身不会像工作量证明那样产生 ommers (即叔块)，在每个区块里的 ommers 列表将是空的，而它的哈希值 (ommersHash) 将会变成一个空列表的 RLP 编码哈希值。同样，因为 difficulty 和 nonce 都是工作量证明的特点，这些字段都会被设为  0，同时遵守它们以字节大小为单位。\\n\\nmixHash 是另一个挖矿相关的字段，这不会被设为 0，而会包含信标链的 RANDAO 值。下文将会更详细地说明。\\n\\n**BLOCKHASH 和 DIFFICULTY 操作码变更**\\n\\n合并后，BLOCKHASH 操作码仍可使用，但由于它不再通过工作量证明进行哈希产生，所以此操作码提供的伪随机性将大大减弱。\\n\\n与此相关， DIFFICULTY 操作码 (0x44) 将会更新并重命名为 RANDOM。合并后，它将会返回由信标链提供的随机性输出。这个操作码将因此成为应用开发者可以使用的随机性来源，它比 BLOCKHASH 更强，尽管仍有偏差。\\n\\nRANDOM  公开的值将存储在 ExecutionPayload ，这也是 mixHash (一个与工作量证明计算相关的值) 存储的地方。数据的 mixHash 字段也将被重命名为 random。\\n\\n下图解释了合并前后 DIFFICULTY 和 RANDOM 操作码的工作原理：\\n\\n![](https://oss-cdn1.bihu-static.com/image/20211203/97bbeb373a7b4f89aec1289dcff49a6e_G44DMKRWGIZQ.jpeg)\\\\\\n\\n\\n合并前，我们看到 0x44  操作码返回区块头里的 difficulty  字段。合并后，重命名为 RANDOM 的这个操作码指向在区块头里之前包含 mixHash 而现在存储来自信标链状态的 random 值的字段。\\\\\\n\\n\\n这个变更在 EIP-4399 被形式化了，同时也给链上应用提供了评估合并是否已经发生的方法。该 EIP 是这样写的：\\n\\n*此外，此 EIP 提议的变更使得智能合约可以确定以太坊是否已经升级到 PoS。这可以通过分析返回的 DIFFICULTY 操作码来实现。返回的值大于  *2\\\\*\\\\*64* 就表明交易正在 PoS 区块上执行。*\\n\\n**出块时间**\\n\\n合并将影响以太坊上的平均出块时间。目前工作量证明机制下，平均每 13 秒出一个区块，实际出块时间有相当大的差异。在权益证明机制下，精确地每 12 秒就会出一个区块，除非是由于验证者离线造成错过了一个 slot 或它们没有即时提交区块。实际上，目前这种情况在少于 1% 的 slot 里发生。\\n\\n这意味着网络上的平均出块时间减少了 1 秒。在计算中假设一个特定平均出块时间的智能合约将需要考虑这一点。\\n\\n**安全头块和最终敲定区块**\\n\\n在工作量证明下总是会有出现重组的可能性。应用通常会等待几个区块在一个新的区块头被挖出，因为这样这些区块不太可能从权威链被移除，或等区块被“确认”。合并后，我们有了 “finalized blocks (最终敲定区块)” 和 “safe head (安全头块)” 的概念。这些区块比工作量证明下的“被确认”区块更可靠，但理解上有区别，需要转变理解才能正确使用。\\n\\n一个最终敲定的区块意味着它被大于 2/3 的验证者接受为权威链的一部分。一个攻击者如果要创建一个冲突区块，它必须烧毁至少总质押金额的 1/3。在写这篇文章时，这意味着在以太坊上超过 100 亿美元 (超过 250 万个 ETH)。\\n\\n一个安全头块是指在正常的网络条件下，我们预期会被包含在权威链上的区块。假设网络延迟少于 4 秒，大多数验证者是诚实的且在分叉选择上没有攻击，安全头块将永远不会有孤块。这个演示文稿详细分析了在各种情况下是如何计算安全头块的。此外，安全头块的假设和保证都将在即将发表的论文里得到正式定义和分析。\\n\\n合并后，执行层的 API (例如 JSON RPC) 将在询问 latest (最新) 区块时默认返回安全头块。在正常网络条件下，安全头块和真正的链头是互相等同的 (安全头只落后几秒)。安全头被重组比现在工作量证明的 latest  区块被重组的可能性要低。如果要公开权益证明链的真正链头，将会有一个 unsafe  (不安全) 的标记添加到 JSON RPC 中。\\n\\n最终敲定的区块也将通过 JSON RPC 公开，会有一个新的 finalized 的标记。这些都可以用作比工作量证明中的确认更强的替代品。下表对这些内容进行了总结：\\n\\n![](https://oss-cdn1.bihu-static.com/image/20211203/6bf74a618a7b49ecbe0f5c95611f36f8\\\\_HAYDAKRTGUZQ.jpeg)\\\\\\n\\n\\n**后续计划**\\n\\n我们希望这篇文章能帮助应用开发者为备受期待的权益证明的到来做好准备。在接下来几周里，一个长期的测试网将会推出，让更广泛的社区参与测试。还会有关于基础设施和工具的合并社区会议，应用开发者可以提问并了解关于合并的最新技术。到时见👋🏻\\n\\n感谢 Mikhail Kalinin 提供关于“安全头”部分的核心内容，感谢 Danny Ryan 和 Matt Garnett 对本贴草稿的审阅。\\n\\n原文链接：https\\\\://blog.ethereum.org/2021/11/29/how-the-merge-impacts-app-layer/\\n\\nECN的翻译工作旨在为中国以太坊社区传递优质资讯和学习资源，文章版权归原作者所有，转载须注明原文出处以及ETH中文站。若需长期转载，请联系eth\\\\@ecn.co进行授权。\\n\\n作者郑重申明：截至发文时，作者与文中提及项目存在利益关系，特此告知。利益关系包括但不限于下述情况：本人为项目团队成员、本人是项目团队成员的直系亲属或配偶、参与投资该项目、持有该项目发行的股份或通证、参与做空或做多该项目、收取回报进行有偿撰文等。\\n\",\"timestamp\":1639118927,\"title\":\"合并将如何影响以太坊应用层\"},\"digest\":\"IhJOSKhctcqIhEdVlQ2zjXlNFqGnu-dayPs-xKdC70o\",\"authorship\":{\"contributor\":\"0xb20Db5dFA0aFf7397413C37ed58C62aA76e56e86\",\"signingKey\":\"{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"cZqEi57EuddmwfWx8LrWT_7Whx34bV4GS6RByBTWHRI\\\",\\\"y\\\":\\\"qoTDL_LpAJviL5DHaRIlcQHAa9IAJMSpe_cybwQjo8k\\\"}\",\"signature\":\"3vP_KQCoPm2W1Jvp4535-LUT_dQzkVAbyWmoC3Z206WJjGJjxlouUZ9yqkwrCRRLRR68h1Ml2g6eixTYjjwMAA\",\"signingKeySignature\":\"0x57cd0fe62a0453233100da1c2d08d6295dce8eec994f1d6ab399c82f9de3355a60e1e78bd534903d417d4762b99e45b79fe26283b747af2517a9e20699023fe01b\",\"signingKeyMessage\":\"I authorize publishing on mirror.xyz from this device using:\\n{\\\"crv\\\":\\\"P-256\\\",\\\"ext\\\":true,\\\"key_ops\\\":[\\\"verify\\\"],\\\"kty\\\":\\\"EC\\\",\\\"x\\\":\\\"cZqEi57EuddmwfWx8LrWT_7Whx34bV4GS6RByBTWHRI\\\",\\\"y\\\":\\\"qoTDL_LpAJviL5DHaRIlcQHAa9IAJMSpe_cybwQjo8k\\\"}\",\"algorithm\":{\"name\":\"ECDSA\",\"hash\":\"SHA-256\"}},\"nft\":{},\"version\":\"12-21-2020\",\"originalDigest\":\"IhJOSKhctcqIhEdVlQ2zjXlNFqGnu-dayPs-xKdC70o\"}"